(()=>{"use strict";const display=document.querySelector("#screen"),keyboard=document.querySelector(".calculator__keyboard");let openBrackets=0;function updateDisplay(t){const e=display.textContent.slice(-1),a=display.textContent.match(/(\d+(\.\d*)?)$/)?.[0]||"";if("+-×÷^.".includes(t)&&"+-×÷^.".includes(e))return display.textContent=display.textContent.slice(0,-1)+t,void saveToLocalStorage();"0"!==a||"."===t||e.includes(".")||/\d/.test(t)&&(display.textContent=display.textContent.slice(0,-1)),"."===t&&a.includes(".")||("0"!==display.textContent||!/\d/.test(t)&&"("!==t?display.textContent+=t:display.textContent=t,saveToLocalStorage())}function insertPower(t){const e=display.textContent.slice(-1);(/\d$/.test(e)||")"===e)&&(display.textContent+="^"+t,saveToLocalStorage())}function insertBracket(t){const e=display.textContent.slice(-1);if("("===t)("0"===display.textContent||"+-×÷^(".includes(e))&&(display.textContent="0"===display.textContent?"(":display.textContent+"(",openBrackets++);else if(")"===t){if(0===openBrackets||"+-×÷^(".includes(e))return;display.textContent+=")",openBrackets--}saveToLocalStorage()}function calculate(){let expression=display.textContent.replace(/×/g,"*").replace(/÷/g,"/").replace(/\^/g,"**");if(expression=expression.replace(/[\+\-\*\/\^\.]+$/,""),expression){try{let result=eval(expression);display.textContent=Number.isFinite(result)?result:"Infinity",openBrackets=0}catch{display.textContent="Ошибка"}saveToLocalStorage()}else display.textContent="0"}function clearDisplay(){display.textContent="0",openBrackets=0,saveToLocalStorage()}function deleteLastChar(){const t=display.textContent.slice(-1);"("===t?openBrackets--:")"===t&&openBrackets++,display.textContent=display.textContent.slice(0,-1)||"0",saveToLocalStorage()}function saveToLocalStorage(){localStorage.setItem("calculatorDisplay",display.textContent),localStorage.setItem("openBrackets",openBrackets)}function loadFromLocalStorage(){const t=localStorage.getItem("calculatorDisplay"),e=localStorage.getItem("openBrackets");null!==t&&(display.textContent=t),null!==e&&(openBrackets=parseInt(e))}loadFromLocalStorage(),keyboard.addEventListener("click",(t=>{const e=t.target;if(!e.classList.contains("calculator__button"))return;["Ошибка","Infinity"].includes(display.textContent)&&clearDisplay();const a=e.dataset.action,n=e.textContent;"number"===a||["add","subtract","multiply","divide"].includes(a)?updateDisplay(n):"power"===a?insertPower(""):"square"===a?insertPower("2"):"sqrt"===a?insertPower("0.5"):"clear"===a?clearDisplay():"delete"===a?deleteLastChar():"bracket"===a?insertBracket(n):"calculate"===a&&calculate()})),document.addEventListener("keydown",(t=>{const e=t.key;["Ошибка","Infinity"].includes(display.textContent)&&clearDisplay(),!isNaN(e)||"+-*/.".includes(e)?updateDisplay(e.replace("*","×").replace("/","÷")):"^"===e?insertPower(""):"("===e||")"===e?insertBracket(e):"Enter"===e?(t.preventDefault(),calculate()):"Backspace"===e?deleteLastChar():"Escape"===e&&clearDisplay()}))})();